<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard | vmedu</title>
    <link href="static/css/style.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

</head>

<body>

    <!-- Mobile Nav Toggle -->
    <button class="mobile-nav-toggle" onclick="UI.toggleSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <div class="dashboard-grid">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <span style="font-size: 1.25em;">ðŸŽ“</span> vmedu
            </div>

            <nav>
                <a class="nav-link active" onclick="UI.switchTab('tab-overview', this)">
                    ðŸ“Š Overview
                </a>
                <a class="nav-link" onclick="UI.switchTab('tab-courses', this)">
                    ðŸ“š Course Management
                </a>
                <a class="nav-link" onclick="UI.switchTab('tab-students', this)">
                    ðŸ‘¥ Student Enrollment
                </a>
                <a class="nav-link" onclick="UI.switchTab('tab-attendance', this)">
                    ðŸ“… Mark Attendance
                </a>
            </nav>

            <div style="margin-top: auto;">
                <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- OVERVIEW TAB -->
            <div id="tab-overview" class="tab-content active">
                <h1 style="margin-bottom: 2rem;">Faculty Overview</h1>

                <div class="glass-card">
                    <h2>Daily Attendance Analysis</h2>
                    <div style="height: 300px; position: relative;">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- COURSES TAB -->
            <div id="tab-courses" class="tab-content">
                <h1 style="margin-bottom: 2rem;">Course Management</h1>

                <div class="glass-card" style="margin-bottom: 2rem;">
                    <h3>Create New Course</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Course
                                Name</label>
                            <input type="text" id="newCourseName" class="input-field"
                                placeholder="e.g. Advanced Mathematics">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Course
                                Code</label>
                            <input type="text" id="newCourseCode" class="input-field" placeholder="e.g. M101">
                        </div>
                        <button class="btn" onclick="createCourse()">+ Create</button>
                    </div>
                </div>

                <div class="glass-card">
                    <h3>Your Courses</h3>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- STUDENTS TAB -->
            <div id="tab-students" class="tab-content">
                <h1 style="margin-bottom: 2rem;">Student Management</h1>

                <div class="glass-card">
                    <h3>Enroll Student</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Add a new student to a specific course.
                    </p>

                    <form id="addStudentForm">
                        <div class="input-group">
                            <label style="display: block; margin-bottom: 0.5rem;">Select Course</label>
                            <select id="enrollCourseSelect" class="input-field" required>
                                <option value="">Select a course...</option>
                            </select>
                        </div>

                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Email</label>
                                <input type="email" id="newEmail" class="input-field" placeholder="student@mlrit.ac.in"
                                    required>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Roll Number</label>
                                <input type="text" id="newRoll" class="input-field" placeholder="24r21a66h5" required>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem;">Password</label>
                                <input type="text" id="newPassword" class="input-field" value="password123" required>
                            </div>
                        </div>

                        <button type="submit" class="btn">Enroll Student</button>
                    </form>
                </div>
            </div>

            <!-- ATTENDANCE TAB -->
            <div id="tab-attendance" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1 style="margin: 0;">Mark Attendance</h1>
                    <button class="btn" onclick="saveAttendance()">ðŸ’¾ Save Attendance</button>
                </div>

                <div class="glass-card" style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">Course</label>
                            <select id="courseSelect" class="input-field">
                                <option value="">Select Course...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">Date</label>
                            <input type="date" id="attendanceDate" class="input-field">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">Search</label>
                            <input type="text" id="searchRoll" class="input-field" placeholder="Search Roll No...">
                        </div>
                    </div>
                </div>

                <div class="glass-card" style="padding: 0;">
                    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                        <div id="studentList" style="padding: 1rem;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="static/js/api.js"></script>
    <script src="static/js/ui.js"></script>

    <script>
        // State
        let allStudents = [];
        let currentAttendance = {};
        let courses = [];
        let selectedCourseId = null;
        let myChart = null;

        // Initialization
        async function init() {
            // Set default date
            const defaultDate = '2026-01-01'; // Fixed for demo as per previous context? Or should use today? 
            // Using 2026-01-01 as per previous conversation context, but usually today is better.
            // Let's stick to the previous code's logic for consistency unless user asked otherwise.
            const dateInput = document.getElementById('attendanceDate');
            dateInput.value = defaultDate;

            await refreshCourses();

            // Setup chart
            initChart();
        }

        async function refreshCourses() {
            try {
                courses = await Api.request('/courses/my');
                updateCourseSelects();
                updateCoursesTable();

                // If we have courses and nothing selected, select first
                if (courses.length > 0 && !selectedCourseId) {
                    selectedCourseId = courses[0].id;
                    document.getElementById('courseSelect').value = selectedCourseId;
                    await loadCourseData();
                }
            } catch (err) {
                console.error(err);
                UI.showToast("Failed to load courses", 'error');
            }
        }

        function updateCourseSelects() {
            const selects = [document.getElementById('courseSelect'), document.getElementById('enrollCourseSelect')];
            selects.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">Select Course...</option>';
                courses.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `${c.name} (${c.code})`;
                    sel.appendChild(opt);
                });
                if (currentVal) sel.value = currentVal;
            });
        }

        function updateCoursesTable() {
            const tbody = document.getElementById('coursesTableBody');
            tbody.innerHTML = courses.map(c => `
                <tr>
                    <td><span style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">${c.code}</span></td>
                    <td><strong>${c.name}</strong></td>
                    <td><button class="btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="UI.showToast('Edit not implemented', 'info')">Edit</button></td>
                </tr>
            `).join('');
        }

        // Course Actions
        async function createCourse() {
            const name = document.getElementById('newCourseName').value;
            const code = document.getElementById('newCourseCode').value;

            if (!name || !code) return UI.showToast("Please enter both name and code", 'warning');

            try {
                await Api.request('/courses/', 'POST', { name, code });
                document.getElementById('newCourseName').value = '';
                document.getElementById('newCourseCode').value = '';
                UI.showToast("Course created successfully!", 'success');
                await refreshCourses();
            } catch (err) {
                UI.showToast(err.message, 'error');
            }
        }

        // Student Enrollment
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const courseId = document.getElementById('enrollCourseSelect').value;

            if (!courseId) return UI.showToast("Please select a course first", 'warning');

            const email = document.getElementById('newEmail').value;
            const roll = document.getElementById('newRoll').value;
            const password = document.getElementById('newPassword').value;

            try {
                // 1. Try create user (ignore if exists)
                try {
                    await Api.request('/users/add', 'POST', {
                        email, password, role: 'student', roll_number: roll
                    });
                } catch (err) {
                    if (!err.message.includes("Email already registered")) throw err;
                }

                // 2. Enroll
                await Api.request(`/courses/${courseId}/enroll?student_email=${email}`, 'POST');

                UI.showToast("Student Enrolled Successfully!", 'success');
                document.getElementById('addStudentForm').reset();

                // If we are currently viewing this course in attendance tab, refresh
                if (selectedCourseId == courseId) {
                    await loadCourseData();
                }

            } catch (err) {
                UI.showToast(err.message, 'error');
            }
        });

        // Attendance Logic
        async function loadCourseData() {
            if (!selectedCourseId) return;

            try {
                // Load Students
                allStudents = await Api.request(`/courses/${selectedCourseId}/students`);

                // Load Attendance for configured date
                const date = document.getElementById('attendanceDate').value;
                if (date) {
                    const records = await Api.request(`/attendance/by_date?date=${date}&course_id=${selectedCourseId}`);
                    currentAttendance = {};
                    records.forEach(r => currentAttendance[r.student_id] = r.status);
                }

                renderStudentList();
            } catch (err) {
                console.error(err);
                UI.showToast("Failed to load course data", 'error');
            }
        }

        function renderStudentList() {
            const list = document.getElementById('studentList');
            const search = document.getElementById('searchRoll').value.toLowerCase();

            // Filter
            const filtered = allStudents.filter(s =>
                (s.roll_number && s.roll_number.toLowerCase().includes(search)) ||
                s.email.toLowerCase().includes(search)
            );

            // Stats for chart
            let presentCount = 0;
            let absentCount = 0;

            list.innerHTML = '';

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No students found. Enroll students in the "Student Enrollment" tab.</div>';
            } else {
                filtered.forEach(student => {
                    const isPresent = currentAttendance[student.id] === 'present';
                    if (isPresent) presentCount++; else absentCount++;

                    const row = document.createElement('div');
                    row.style.cssText = `
                        display: flex; justify-content: space-between; align-items: center;
                        padding: 1rem; border-bottom: 1px solid #f1f5f9;
                    `;
                    row.innerHTML = `
                        <div>
                            <div style="font-weight: 600;">${student.roll_number || 'No Roll No'}</div>
                            <div style="font-size: 0.9em; color: var(--text-muted);">${student.email}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label class="switch">
                                <input type="checkbox" onchange="updateLocalStatus(${student.id}, this.checked)" ${isPresent ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span style="width: 60px; font-weight: 500; color: ${isPresent ? 'var(--success)' : 'var(--danger)'}">
                                ${isPresent ? 'Present' : 'Absent'}
                            </span>
                        </div>
                    `;
                    list.appendChild(row);
                });
            }

            updateChart(presentCount, absentCount);
        }

        function updateLocalStatus(studentId, isChecked) {
            currentAttendance[studentId] = isChecked ? 'present' : 'absent';
            // Re-render to update text color and chart immediately
            renderStudentList();
        }

        async function saveAttendance() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) return UI.showToast("Please select a date", 'warning');
            if (!selectedCourseId) return UI.showToast("Please select a course", 'warning');

            const payload = allStudents.map(s => ({
                student_id: s.id,
                date: date,
                status: currentAttendance[s.id] || 'absent',
                course_id: parseInt(selectedCourseId)
            }));

            try {
                await Api.request('/attendance/batch_upsert', 'POST', payload);
                UI.showToast("Attendance saved successfully!", 'success');
            } catch (err) {
                UI.showToast("Error saving: " + err.message, 'error');
            }
        }

        // Chart
        function initChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    cutout: '70%'
                }
            });
        }

        function updateChart(present, absent) {
            if (myChart) {
                myChart.data.datasets[0].data = [present, absent];
                myChart.update();
            }
        }

        // Event Listeners
        document.getElementById('courseSelect').addEventListener('change', (e) => {
            selectedCourseId = e.target.value;
            loadCourseData();
        });

        document.getElementById('attendanceDate').addEventListener('change', () => {
            loadCourseData();
        });

        document.getElementById('searchRoll').addEventListener('input', () => {
            renderStudentList();
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Start
        init();
    </script>
</body>

</html>